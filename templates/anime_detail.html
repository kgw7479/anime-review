<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ anime.title }} - Anime Review</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <script>
        // ë‹¤í¬ ëª¨ë“œ ìœ ì§€
        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("theme") === "dark") {
                document.body.classList.add("dark");
            }
            updateCharCount();
        });

        function toggleTheme() {
            document.body.classList.toggle("dark");
            localStorage.setItem(
                "theme",
                document.body.classList.contains("dark") ? "dark" : "light"
            );
        }

        // ìŠ¤í¬ì¼ëŸ¬ í† ê¸€
        function toggleSpoiler(id) {
            const el = document.getElementById("spoiler-" + id);
            if (!el) return;
            el.style.display = (el.style.display === "block") ? "none" : "block";
        }

        // ê¸€ììˆ˜ ì¹´ìš´í„°
        function updateCharCount() {
            const textarea = document.getElementById("content");
            const counter = document.getElementById("content-counter");
            if (!textarea || !counter) return;
            const maxLen = 500;
            const len = textarea.value.length;
            counter.textContent = len + " / " + maxLen + "ì";
        }
    </script>
</head>
<body>
<header class="site-header">
    <div class="site-header-inner">
        <div>
            <h1 class="logo">Anime Review</h1>
            <p class="logo-subtitle">{{ anime.title }} ë¦¬ë·° í˜ì´ì§€</p>
        </div>
        <nav class="site-nav">
            <a href="{{ url_for('anime_list') }}" class="nav-link">ì• ë‹ˆ ëª©ë¡</a>
            <button type="button" class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>
        </nav>
    </div>
</header>

<main class="container">
    <!-- flash ë©”ì‹œì§€ -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flash-messages">
          {% for msg in messages %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <!-- ìƒë‹¨ ì‘í’ˆ ì •ë³´ -->
    <section class="detail-header">
        <img src="{{ url_for('static', filename=anime.image_url) }}"
             alt="{{ anime.title }}"
             class="detail-poster">

        <div class="detail-info">
            <h2 class="detail-title">{{ anime.title }}</h2>

            <p class="detail-genre">
                ì¥ë¥´: <span class="badge-genre">{{ anime.genre }}</span>
            </p>

            {% if anime.year or anime.episodes %}
                <p class="detail-meta">
                    {% if anime.year %} ë°©ì˜ ì—°ë„: {{ anime.year }} {% endif %}
                    {% if anime.year and anime.episodes %} Â· {% endif %}
                    {% if anime.episodes %} {{ anime.episodes }}í™” {% endif %}
                </p>
            {% endif %}

            {% if anime.avg_rating %}
                <p class="detail-rating">
                    í‰ê·  ë³„ì : â˜… {{ "%.1f"|format(anime.avg_rating) }} / 10
                    ({{ anime.review_count }}ëª…)
                </p>
            {% else %}
                <p class="detail-rating">í‰ê·  ë³„ì : ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}

            {% if anime.description %}
                <p class="detail-description">{{ anime.description }}</p>
            {% endif %}

            <a href="{{ url_for('anime_list') }}" class="back-link">â† ì• ë‹ˆ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </section>

    <hr class="section-divider">

    <!-- ë¦¬ë·° ì‘ì„± -->
    <section class="review-section">
        <h3>ë¦¬ë·° ë‚¨ê¸°ê¸°</h3>

        <form action="{{ url_for('add_review', anime_id=anime.id) }}"
              method="post"
              class="review-form">
            <div class="form-row">
                <label for="rating">ë³„ì </label>
                <select id="rating" name="rating">
                    {% for i in range(1, 11) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
                <span class="rating-max">/ 10</span>
            </div>

            <div class="form-row">
                <label for="spoiler">ìŠ¤í¬ì¼ëŸ¬ í¬í•¨?</label>
                <input id="spoiler" type="checkbox" name="spoiler">
            </div>

            <div class="form-row">
                <label for="content">ë¦¬ë·°</label>
                <textarea id="content"
                          name="content"
                          rows="4"
                          maxlength="500"
                          oninput="updateCharCount()"
                          placeholder="ì—í”¼ì†Œë“œ, ìºë¦­í„°, ì—°ì¶œ, ëŠë‚€ ì  ë“± ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”."></textarea>
                <div id="content-counter" class="char-counter">0 / 500ì</div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">ë¦¬ë·° ë“±ë¡</button>
            </div>
        </form>
    </section>

    <!-- ë¦¬ë·° ëª©ë¡ -->
    <section class="review-section">
        <h3>ë¦¬ë·° ëª©ë¡</h3>

        <div class="review-sort">
            <a href="?sort=newest" class="sort-btn {% if sort=='newest' %}active{% endif %}">ìµœì‹ ìˆœ</a>
            <a href="?sort=rating_desc" class="sort-btn {% if sort=='rating_desc' %}active{% endif %}">ë³„ì  ë†’ì€ ìˆœ</a>
            <a href="?sort=rating_asc" class="sort-btn {% if sort=='rating_asc' %}active{% endif %}">ë³„ì  ë‚®ì€ ìˆœ</a>
            <a href="?sort=likes" class="sort-btn {% if sort=='likes' %}active{% endif %}">ì¢‹ì•„ìš” ìˆœ</a>
        </div>

        {% if reviews %}
            <ul class="review-list">
                {% for r in reviews %}
                    <li class="review-card">
                        <div class="review-header">
                            <span class="review-rating">â˜… {{ r.rating }}</span>
                            {% if r.created_date %}
                                <span class="review-date">
                                    {{ r.created_date.strftime('%Y-%m-%d') }}
                                </span>
                            {% endif %}
                        </div>

                        {% if r.spoiler %}
                            <button type="button"
                                    class="spoiler-btn"
                                    onclick="toggleSpoiler('{{ r.id }}')">
                                ìŠ¤í¬ì¼ëŸ¬ ë³´ê¸°
                            </button>
                            <p id="spoiler-{{ r.id }}"
                               class="spoiler-content"
                               style="display:none;">
                                {{ r.content }}
                            </p>
                        {% else %}
                            <p class="review-content">{{ r.content }}</p>
                        {% endif %}

                        <div class="review-footer">
                            <form action="{{ url_for('like_review', anime_id=anime.id, review_id=r.id) }}"
                                  method="post"
                                  class="inline-form">
                                <button type="submit" class="btn-like">
                                    ğŸ‘ ì¢‹ì•„ìš” {{ r.like_count }}
                                </button>
                            </form>

                            <form action="{{ url_for('delete_review', anime_id=anime.id, review_id=r.id) }}"
                                  method="post"
                                  class="inline-form">
                                <button type="submit" class="btn-secondary">ì‚­ì œ</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="review-empty">ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
        {% endif %}
    </section>
</main>
</body>
</html>
