<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>{{ anime.title }} - Anime Review</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- JS ì•ˆì— Jinja ë¬¸ë²• ì—†ìŒ -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ìŠ¤í¬ì¼ëŸ¬ ë²„íŠ¼
            var spoilerButtons = document.querySelectorAll(".spoiler-btn");
            spoilerButtons.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var id = btn.dataset.reviewId;
                    var content = document.getElementById("spoiler-" + id);
                    if (!content) return;
                    content.classList.toggle("open");
                });
            });

            // ì¢‹ì•„ìš” ë²„íŠ¼ (AJAX)
            var likeButtons = document.querySelectorAll(".like-btn");
            likeButtons.forEach(function (btn) {
                btn.addEventListener("click", function (event) {
                    event.preventDefault();
                    var id = btn.dataset.reviewId;
                    var countSpan = document.getElementById("like-count-" + id);

                    fetch("/review/" + id + "/like", {
                        method: "POST"
                    }).then(function (response) {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.json();
                    }).then(function (data) {
                        if (countSpan && typeof data.likes !== "undefined") {
                            countSpan.textContent = data.likes;
                        }
                    }).catch(function (error) {
                        console.error("Error:", error);
                    });
                });
            });
        });
    </script>
</head>
<body>
<header class="site-header">
    <div class="site-header-inner">
        <h1 class="logo">Anime Review</h1>
        <nav class="site-nav">
            <a href="{{ url_for('anime_list') }}" class="nav-link">ì• ë‹ˆ ëª©ë¡</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="detail-header">
        <img src="{{ url_for('static', filename=anime.image_url) }}"
             alt="{{ anime.title }}"
             class="detail-poster">

        <div class="detail-info">
            <h2 class="detail-title">{{ anime.title }}</h2>

            <p class="detail-genre">
                ì¥ë¥´:
                <span class="badge-genre">{{ anime.genre }}</span>
                {% if anime.year %}
                    <span class="badge-year">{{ anime.year }}</span>
                {% endif %}
                {% if anime.episodes %}
                    <span class="badge-episodes">{{ anime.episodes }}í™”</span>
                {% endif %}
            </p>

            {% if anime.avg_rating %}
                <p class="detail-rating">
                    í‰ê·  ë³„ì :
                    <span class="rating-strong">
                        â˜… {{ "%.1f"|format(anime.avg_rating) }} / 10
                    </span>
                    <span class="rating-count">({{ anime.review_count }}ëª…)</span>
                </p>
            {% else %}
                <p class="detail-rating">
                    í‰ê·  ë³„ì : <span class="rating-empty">ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</span>
                </p>
            {% endif %}

            {% if anime.description %}
                <p class="detail-desc">{{ anime.description }}</p>
            {% endif %}

            <a href="{{ url_for('anime_list') }}" class="back-link">â† ì• ë‹ˆ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </section>

    <hr class="section-divider">

    <!-- flash ë©”ì‹œì§€ -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class="flash-list">
                {% for msg in messages %}
                    <li class="flash-item">{{ msg }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <!-- ë¦¬ë·° ì‘ì„± -->
    <section class="review-section">
        <h3>ë¦¬ë·° ë‚¨ê¸°ê¸°</h3>
        <form action="{{ url_for('add_review', anime_id=anime.id) }}" method="post" class="review-form">
            <div class="form-row">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input id="nickname" name="nickname" type="text" class="input-text" maxlength="30" required>
            </div>

            <div class="form-row">
                <label for="password">ë¹„ë°€ë²ˆí˜¸ (ì‚­ì œìš©)</label>
                <input id="password" name="password" type="password" class="input-text" required>
            </div>

            <div class="form-row">
                <label for="rating">ë³„ì </label>
                <select id="rating" name="rating">
                    {% for i in range(1, 11) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
                <span class="rating-max">/ 10</span>
            </div>

            <div class="form-row">
                <label>
                    <input type="checkbox" name="spoiler">
                    ìŠ¤í¬ì¼ëŸ¬ í¬í•¨
                </label>
            </div>

            <div class="form-row">
                <label for="content">ë¦¬ë·°</label>
                <textarea id="content"
                          name="content"
                          rows="4"
                          maxlength="500"
                          placeholder="ì—í”¼ì†Œë“œ, ìºë¦­í„°, ì—°ì¶œ, ëŠë‚€ ì  ë“± ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”. (ìµœëŒ€ 500ì)">
                </textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">ë¦¬ë·° ë“±ë¡</button>
            </div>
        </form>
    </section>

    <!-- ë¦¬ë·° ëª©ë¡ + ì •ë ¬ -->
    <section class="review-section">
        <div class="review-header-row">
            <h3>ë¦¬ë·° ëª©ë¡</h3>

            <form method="get" action="{{ url_for('anime_detail', anime_id=anime.id) }}">
                <select name="sort" class="input-select">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
                    <option value="rating_desc" {% if sort == 'rating_desc' %}selected{% endif %}>ë³„ì  ë†’ì€ ìˆœ</option>
                    <option value="rating_asc" {% if sort == 'rating_asc' %}selected{% endif %}>ë³„ì  ë‚®ì€ ìˆœ</option>
                    <option value="likes" {% if sort == 'likes' %}selected{% endif %}>ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
                </select>
                <button type="submit" class="btn-secondary">ì •ë ¬</button>
            </form>
        </div>

        {% if reviews %}
            <ul class="review-list">
                {% for r in reviews %}
                    <li class="review-item">
                        <div class="review-header">
                            <span class="review-rating">â˜… {{ r.rating }} / 10</span>
                            <span class="review-nickname">{{ r.nickname }}</span>
                            <span class="review-date">
                                {{ r.created_date.strftime("%Y-%m-%d %H:%M") if r.created_date else "" }}
                            </span>
                            {% if r.spoiler %}
                                <span class="badge-spoiler">ìŠ¤í¬ì¼ëŸ¬</span>
                            {% endif %}
                        </div>

                        {% if r.spoiler %}
                            <button type="button"
                                    class="spoiler-btn"
                                    data-review-id="{{ r.id }}">
                                ìŠ¤í¬ì¼ëŸ¬ ë³´ê¸°
                            </button>
                            <p id="spoiler-{{ r.id }}"
                               class="review-content spoiler-content">
                                {{ r.content }}
                            </p>
                        {% else %}
                            <p class="review-content">{{ r.content }}</p>
                        {% endif %}

                        <div class="review-actions">
                            <button type="button"
                                    class="like-btn"
                                    data-review-id="{{ r.id }}">
                                ğŸ‘ <span id="like-count-{{ r.id }}">{{ r.like_count }}</span>
                            </button>

                            <form action="{{ url_for('delete_review', anime_id=anime.id, review_id=r.id) }}"
                                  method="post"
                                  class="review-delete-form">
                                <input type="password"
                                       name="password"
                                       class="input-text input-password-inline"
                                       placeholder="ë¹„ë°€ë²ˆí˜¸">
                                <button type="submit" class="btn-secondary">ì‚­ì œ</button>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="review-empty">ì•„ì§ ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
        {% endif %}
    </section>
</main>
</body>
</html>
