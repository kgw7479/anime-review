<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{{ anime.title }} - Anime Review</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // í‰ì ë°” fill
      var fill = document.querySelector(".rating-bar-fill");
      if (fill) {
        var pct = Number(fill.dataset.pct || "0");
        if (isNaN(pct)) pct = 0;
        pct = Math.max(0, Math.min(100, pct));
        fill.style.width = pct + "%";
      }

      // ìŠ¤í¬ì¼ëŸ¬ í† ê¸€
      document.querySelectorAll(".spoiler-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var id = btn.dataset.reviewId;
          var content = document.getElementById("spoiler-" + id);
          if (!content) return;
          content.classList.toggle("open");
        });
      });

      // ì¢‹ì•„ìš” AJAX
      document.querySelectorAll(".like-btn").forEach(function (btn) {
        btn.addEventListener("click", function (event) {
          event.preventDefault();
          var id = btn.dataset.reviewId;
          var countSpan = document.getElementById("like-count-" + id);

          fetch("/review/" + id + "/like", { method: "POST" })
            .then(function (r) { if (!r.ok) throw new Error("Network"); return r.json(); })
            .then(function (data) {
              if (countSpan && typeof data.likes !== "undefined") countSpan.textContent = data.likes;
            })
            .catch(function () {});
        });
      });

      // ê¸€ììˆ˜ ì¹´ìš´í„°
      var ta = document.getElementById("content");
      var counter = document.getElementById("char-count");
      if (ta && counter) {
        var sync = function () { counter.textContent = (ta.value || "").length + " / 500"; };
        ta.addEventListener("input", sync);
        sync();
      }

      // ì¤‘ë³µ ì œì¶œ ë°©ì§€
      var form = document.getElementById("review-form");
      if (form) {
        form.addEventListener("submit", function () {
          var b = document.getElementById("submit-review");
          if (b) { b.disabled = true; b.textContent = "ë“±ë¡ ì¤‘..."; }
        });
      }
    });
  </script>
</head>

<body>
<header class="site-header">
  <div class="site-header-inner">
    <div class="brand-wrap">
      <h1 class="logo">Anime Review</h1>
      <p class="logo-subtitle">ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ì• ë‹ˆë¥¼ ê¸°ë¡í•˜ëŠ” ì‘ì€ ë¦¬ë·° ì‚¬ì´íŠ¸</p>
    </div>
    <nav class="site-nav">
      <a href="{{ url_for('anime_list') }}" class="nav-link">ì• ë‹ˆ ëª©ë¡</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="detail-header">
    <img src="{{ url_for('static', filename=anime.image_url) }}"
         alt="{{ anime.title }}"
         class="detail-poster">

    <div class="detail-info">
      <h2 class="detail-title">{{ anime.title }}</h2>

      <div class="detail-meta">
        <span class="badge-genre">{{ anime.genre }}</span>
        {% if anime.year %}<span class="badge-year">{{ anime.year }}</span>{% endif %}
        {% if anime.episodes %}<span class="badge-episodes">{{ anime.episodes }}í™”</span>{% endif %}
      </div>

      <div class="rating-panel">
        {% if anime.avg_rating %}
          <div class="rating-top">
            <span class="rating-big">â˜… {{ "%.1f"|format(anime.avg_rating) }}</span>
            <span class="rating-small">/ 10</span>
            <span class="rating-count">({{ anime.review_count }}ëª…)</span>
          </div>

          <div class="rating-bar">
            <div class="rating-bar-fill"
                 data-pct="{{ ((anime.avg_rating / 10) * 100) | round(0) }}"></div>
          </div>

          <div class="rating-hint">í‰ê·  ì ìˆ˜ ì‹œê°í™”</div>
        {% else %}
          <div class="rating-top">
            <span class="rating-big rating-empty">ì•„ì§ ë³„ì ì´ ì—†ì–´ìš”</span>
          </div>
          <div class="rating-hint">ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì„œ ì ìˆ˜ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš” âœ¨</div>
        {% endif %}
      </div>

      {% if anime.description %}
        <p class="detail-desc">{{ anime.description }}</p>
      {% endif %}

      <a href="{{ url_for('anime_list') }}" class="back-link">â† ì• ë‹ˆ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </section>

  <hr class="section-divider">

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul class="flash-list">
        {% for msg in messages %}
          <li class="flash-item">{{ msg }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <!-- ë¦¬ë·° ì‘ì„± -->
  <section class="review-section" id="review-form-anchor">
    <div class="section-head-row">
      <h3>ë¦¬ë·° ë‚¨ê¸°ê¸°</h3>
      <div class="mini-muted">ë‹‰ë„¤ì„/ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚­ì œì— ì‚¬ìš©ë¼ìš”</div>
    </div>

    <form action="{{ url_for('add_review', anime_id=anime.id) }}"
          method="post"
          class="review-form"
          id="review-form">

      <div class="form-grid">
        <div class="form-row">
          <label for="nickname">ë‹‰ë„¤ì„</label>
          <input id="nickname" name="nickname" type="text" class="input-text" maxlength="30" required>
        </div>

        <div class="form-row">
          <label for="password">ë¹„ë°€ë²ˆí˜¸ (ì‚­ì œìš©)</label>
          <input id="password" name="password" type="password" class="input-text" required>
        </div>

        <div class="form-row">
          <label for="rating">ë³„ì </label>
          <div class="rating-select-row">
            <select id="rating" name="rating" class="input-select select-active">
              {% for i in range(1, 11) %}
                <option value="{{ i }}">{{ i }}</option>
              {% endfor %}
            </select>
            <span class="rating-max">/ 10</span>
          </div>
        </div>

        <div class="form-row spoiler-row">
          <label class="checkbox">
            <input type="checkbox" name="spoiler">
            ìŠ¤í¬ì¼ëŸ¬ í¬í•¨
          </label>
        </div>
      </div>

      <div class="form-row">
        <div class="textarea-head">
          <label for="content">ë¦¬ë·°</label>
          <span class="char-count" id="char-count">0 / 500</span>
        </div>

        <textarea id="content"
                  name="content"
                  maxlength="500"
                  placeholder="ì—í”¼ì†Œë“œ, ìºë¦­í„°, ì—°ì¶œ, ëŠë‚€ ì  ë“± ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”. (ìµœëŒ€ 500ì)"></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn-primary" id="submit-review">ë¦¬ë·° ë“±ë¡</button>
      </div>
    </form>
  </section>

  <!-- ë¦¬ë·° ëª©ë¡ -->
  <section class="review-section" id="reviews">
    <div class="review-header-row">
      <h3 style="margin:0;">ë¦¬ë·° ëª©ë¡</h3>

      <form method="get" action="{{ url_for('anime_detail', anime_id=anime.id) }}" class="sort-form">
        <select name="sort" class="input-select select-active">
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
          <option value="rating_desc" {% if sort == 'rating_desc' %}selected{% endif %}>ë³„ì  ë†’ì€ ìˆœ</option>
          <option value="rating_asc" {% if sort == 'rating_asc' %}selected{% endif %}>ë³„ì  ë‚®ì€ ìˆœ</option>
          <option value="likes" {% if sort == 'likes' %}selected{% endif %}>ì¢‹ì•„ìš” ë§ì€ ìˆœ</option>
        </select>
        <button type="submit" class="btn-secondary">ì •ë ¬</button>
      </form>
    </div>

    {% if reviews %}
      <ul class="review-list">
        {% for r in reviews %}
          <li class="review-item">
            <div class="review-header">
              <span class="review-rating">â˜… {{ r.rating }} / 10</span>
              <span class="review-nickname">{{ r.nickname }}</span>
              <span class="review-date">
                {{ r.created_date.strftime("%Y-%m-%d %H:%M") if r.created_date else "" }}
              </span>
              {% if r.spoiler %}
                <span class="badge-spoiler">ìŠ¤í¬ì¼ëŸ¬</span>
              {% endif %}
            </div>

            {% if r.spoiler %}
              <button type="button" class="spoiler-btn" data-review-id="{{ r.id }}">ìŠ¤í¬ì¼ëŸ¬ ë³´ê¸°</button>
              <p id="spoiler-{{ r.id }}" class="review-content spoiler-content">{{ r.content }}</p>
            {% else %}
              <p class="review-content">{{ r.content }}</p>
            {% endif %}

            <div class="review-actions">
              <button type="button" class="like-btn" data-review-id="{{ r.id }}">
                ğŸ‘ <span id="like-count-{{ r.id }}">{{ r.like_count }}</span>
              </button>

              <form action="{{ url_for('delete_review', anime_id=anime.id, review_id=r.id) }}"
                    method="post"
                    class="review-delete-form">
                <input type="password"
                       name="password"
                       class="input-text input-password-inline"
                       placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button type="submit" class="btn-secondary">ì‚­ì œ</button>
              </form>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-card">
        <div class="empty-title">ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš”</div>
        <div class="empty-sub">ì²« ë¦¬ë·°ì–´ê°€ ë˜ì–´ë³´ì„¸ìš” âœ¨</div>
        <a class="btn-secondary" href="#review-form-anchor">ë¦¬ë·° ì‘ì„±í•˜ëŸ¬ ê°€ê¸°</a>
      </div>
    {% endif %}
  </section>
</main>

<!-- ë’¤ë¡œê°€ê¸° ìºì‹œ ì™„í™”: ë¦¬ë·° ë“±ë¡ í›„ ë’¤ë¡œê°€ë„ â€œë¦¬ë·° ì—†ìŒâ€ìœ¼ë¡œ ëŒì•„ê°€ëŠ” í˜„ìƒ ì™„í™” -->
<script>
  if (window.history && history.replaceState) {
    history.replaceState(null, "", location.href);
  }
  window.addEventListener("pageshow", function (event) {
    if (event.persisted) window.location.reload();
  });
</script>
</body>
</html>
